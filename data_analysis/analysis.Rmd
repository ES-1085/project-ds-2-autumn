---
title: "Analysis"
author: "Autumn Pauly and Asher Panikian"
output: github_document
---

# Loading the Data
```{r loading-packages}
library(tidyverse)
knitr::opts_chunk$set(echo = TRUE)
library(RColorBrewer)
library(stringr)
```

```{r reading-CSV}
seot = read.csv("/cloud/project/data/seot.csv", h = T)
```


# Glimpsing the Data
## Yearly Observations
First, let's look at the yearly observations for the sea otters. [add something here about the gap between 1970 and 1985]. 

```{r glimpsing data}
seot %>% 
  ggplot(aes(x = YEAR)) +
  geom_histogram(binwidth = 1) + 
  labs(title = "Count of Observations Per Year",
       x = "Year", 
       y = "Count")
```

```{r counting-observations}
seot %>% 
  count(YEAR)
```


## Age Diversity Among Sexes With Observations

```{r age}
seot %>% 
  filter(SEX != "U") %>% 
  ggplot(aes(x=FINAL_AGE, fill = SEX)) + 
   geom_histogram(binwidth = 1) + 
  xlim(0,25) + 
  facet_grid(~SEX)
```

# Statistical Analysis 
## Paw Width and Prey
The paw width data was collected in an effort to study the estimates of prey size in relation to paw size for sea otter foraging studies. If we are able to find the appropriate datasets, it would be interesting to study the relationship between paw size and prey size.

## Canine and Sexing
The canine width was measured as a potential metric to sex the individuals. We would like to see if there are any significant differences between male canine lengths and female canine lengths (with respect to the ages of the individuals).

The canine measurement is labeled under the `CAN_DIA` column, where a measurement of the diameter of canine tooth (mm) was taken at the gum line, which is the widest dimension. This canine width was measured with a caliper and recorded to the nearest 0.1 mm. 

### Creating Plots
Let's create a plot to visualize the distribution of the data. This will help us determine which type of statistical test will be the most appropriate to use. First, we have to filter the `seot` dataset so that we will be able to visualize the `CAN_DIA` and `SEX` variables that we're interested in. 

```{r glimpsing-canine-measurement-by-sex}
seot_sex <- seot %>% 
  mutate(CAN_DIA = as.numeric(CAN_DIA)) %>% 
  filter(SEX != "U") %>% 
  filter(CAN_DIA > 0)

#scatterplot
ggplot(data = seot_sex, mapping = aes(x = SEX, y = CAN_DIA, color = SEX)) + 
  geom_jitter() + 
  ylim(2,12) + 
  labs(title = "Canine Diameter by Sex",
       x = "Sex",
       y = "Diameter (mm)", 
       color = "Sex")

#boxplot
ggplot(data = seot_sex, mapping = aes(x = SEX, y = CAN_DIA, color = SEX)) + 
  geom_boxplot() + 
  ylim(2,12) + 
  labs(title = "Canine Diameter by Sex",
       x = "Sex",
       y = "Diameter (mm)", 
       color = "Sex")
```

```{r canine-histogram}
#histogram
ggplot(data = seot_sex, mapping = aes(x = CAN_DIA, fill = SEX)) +
  geom_histogram() + 
  facet_grid(~SEX) + 
  xlim(2,13) + 
  theme_gray() + 
  brewer.pal()
  labs( title = "Canine Diameter of Sea Otters", 
        subtitle = "by Sex", 
        x = "Canine Diameter (mm)", 
        y = "Count", 
        fill = "Sex")
```

To truly determine if the measurement of the canine diameter at the gum line is an appropriate metric by which to sex a sea otter, statistical testing should be performed. As was seen above, the distribution of both sexes appears to conform to a normal distribution. This suggests that we can use a test that follows a two-sample t-test with equal variance. 

```{r stats-canine-ttest}
t.test(CAN_DIA ~ SEX, data = seot_sex, var.equal = TRUE)
```

The diameter of the canine tooth for female sea otters is significantly smaller than that of the male otters (Two Sample t-test; t = -19.164, df = 1132, p-value < 2.2e-16). This would mean that this would be an appropriate metric by which to determine the sex of an unknown sea otter. 

## Baculum Length and Aging

The baculum length was measured on males a way to estimate age-class of the animal. We would like to perform statistical analysis on if there is a difference in baculum length in males of various ages and if this is an appropriate metric by which to estimate the age of male individuals.

The baculum measurement is found under the `BACULA_LGTH` column with the unit of measurement being centimeters. The baculum length was measure using a tape measure and feeling the ends of the bone and recorded to the nearest 0.5 cm.

### Creating Plots
Let's create a plot to visualize the distribution of the data. This will help us determine which type of statistical test will be the most appropriate to use. First, we have to filter the `seot` dataset so that we will be able to visualize the `BACULA_LGTH` and `FINAL_AGE` variables that we're interested in. 

```{r baculum-length-visualization}
seot_baculum <- seot %>% 
  filter(SEX == "M") %>% 
  mutate(FINAL_AGE = as.numeric(FINAL_AGE)) %>% 
  filter(FINAL_AGE > 0) %>% 
  mutate(BACULA_LGTH = as.numeric(BACULA_LGTH)) %>% 
  filter(BACULA_LGTH > 0)

ggplot(data = seot_baculum, mapping = aes(x = FINAL_AGE, y = BACULA_LGTH, color = FINAL_AGE)) +
  geom_jitter() + 
  geom_smooth() + 
  labs(title = "Baculum Length by Age", 
       x = "Final Age", 
       y = "Bacula Length (cm)", 
       color = "Age")
```

The statistics that we find with the Tukey HSD test that we performed is a little convoluted, so let's tidy this up and group ages into categories and try again. 

```{r tukeyhsd-baculumlength-finalage}
#create dataframe that includes the variables we want
seot_baculum <- seot_baculum %>% 
  mutate(FINAL_AGE = as.factor(FINAL_AGE)) %>% 
  select(BACULA_LGTH, FINAL_AGE) 
seot_baculum

#creating the ANOVA test
aovbaculum <- aov(BACULA_LGTH~FINAL_AGE, data = seot_baculum)
summary(aovbaculum)

#Tukey HSD Test
TukeyHSD(aovbaculum)
```

Now we can more clearly see how the baculum length relates to ages. 

```{r tukeyhsd-baculumlength-agecategory}
#create dataframe that includes the variables we want
seot_baculum_2 <- seot %>% 
  filter(SEX == "M") %>% 
  mutate(AGE_CATEGORY = as.numeric(AGE_CATEGORY)) %>% 
  filter(AGE_CATEGORY > 0) %>% 
  mutate(BACULA_LGTH = as.numeric(BACULA_LGTH)) %>% 
  filter(BACULA_LGTH > 0)

seot_baculum_2 <- seot_baculum_2 %>% 
  mutate(AGE_CATEGORY = as.factor(AGE_CATEGORY)) %>% 
  select(BACULA_LGTH, AGE_CATEGORY) 
seot_baculum_2

#creating the ANOVA test
aovbaculum2 <- aov(BACULA_LGTH~AGE_CATEGORY, data = seot_baculum_2)
summary(aovbaculum2)

#Tukey HSD Test
TukeyHSD(aovbaculum2)
```

The baculum length of individuals who are ages 1 - 7 are significantly different than one another (one-way ANOVA, F_2,457, = 112, P < 0.005). In a Tukey HSD post-hoc test, the baculum length of individuals who were from ages 7 to 13 did not differ significantly (refer to Tukey multiple comparisons of means). This would suggest that you could use the baculum length to estimate the age of individuals who were 7 years or younger, but not for individuals who are over 7 years old. 

#Creating a Model of Baculum Length by Age

```{r install-tidymodels}
install.packages("tidymodels")
library(tidymodels)
```

For each additional year, the male otter's baculum is expected to grow by 0.22 cm. For otters that are 0 (aka newborn), the baculum length is expected to be 14.33 cm. 
```{r model-baculum-vs-age}
#first, we need to filter out the na values (that being -9.0)
seot_bacula <- seot %>% 
  filter(BACULA_LGTH > 0)

#now, let's create the linear model comparing final age to baculum length
seot_model_baculum <- linear_reg() %>%
  set_engine("lm") %>% 
  fit(BACULA_LGTH ~ FINAL_AGE, data = seot_bacula)

#let's tidy this model
seot_model_baculum %>% tidy()
```

```{r graphical-diagnostics-baculum}
#augmenting the baculum data
seot_model_baculum_augment <- augment(seot_model_baculum$fit)

ggplot(seot_model_baculum_augment, mapping = aes(x = .fitted, y = .resid)) +
  geom_jitter(alpha = 0.5) +
  geom_hline(yintercept = 0, color = "gray", lty = "dashed") +
  labs(x = "Predicted Age", y = "Residuals")

#assessing the r-squared value
glance(seot_model_baculum)$adj.r.squared
```


## Recapture Data 

```{r recaptured-otters}
seot %>% 
  mutate(OTTER.NO = as.factor(OTTER.NO)) %>% 
  count(OTTER.NO) %>% 
  arrange(desc(n))
```

```{r recapture-data-again}
seot %>% 
  filter(OTTER.NO == "SO-01-28") %>% 
  select(YEAR, OTTER.NO, FINAL_AGE, SEX)

seot %>% 
  filter(OTTER.NO == "SO-02-07") %>% 
  select(YEAR, OTTER.NO, FINAL_AGE, SEX)

seot %>% 
  filter(FINAL_AGE > 0) %>% 
  select(YEAR, OTTER.NO, FINAL_AGE, SEX)
```

# Spatial Analysis

## Introduction

```{r lat-long-glimpse}
seot %>% 
  filter(REGION == "west_aleutians") %>% 
  count(LOCATION)

seot %>% 
  count(REGION)
```

```{r filtering-by-location}
#creating a plot that visualizes the relationship between weight and tail length
ggplot(data = seot, mapping = aes(x = WEIGHT, y = mean_tail_lgth)) + 
  geom_point() + 
  ylim(10, 50) + 
  xlim(0, 50) + 
  geom_smooth()
```



