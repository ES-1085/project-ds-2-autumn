---
title: "Analysis"
author: "Autumn Pauly and Asher Panikian"
output: github_document
---

# Loading the Data
First, we'll want to load the appropriate packages and data for the analysis of this dataset.

```{r loading-packages, echo = FALSE}
library(tidyverse)
knitr::opts_chunk$set(echo = TRUE)
library(RColorBrewer)
library(stringr)
#install.packages("plotly")
#library(plotly)
#install.packages("gapminder")
#library(gapminder)
```

```{r reading-CSV, echo = FALSE}
#posit cloud
#seot = read.csv("/cloud/project/data/seot.csv", h = T)

#computer
seot = read.csv("~/GitHub/project-ds-2-autumn/project-ds-2-autumn/data/seot.csv", h = T)
```

# Glimpsing the Data

## Yearly Observations
First, let's look at the yearly observations for the sea otters. As can be shown below, there is a gap in data collection starting from the year 1970 through 1985. This will need to be accounted for if there is any analysis on temporal differences. 

```{r glimpsing data}
#counting observations per year
#seot %>% 
  #count(YEAR)

#visualizing the observation per year in a histogram
seot %>% 
  ggplot(aes(x = YEAR, fill = YEAR)) +
  geom_histogram(binwidth = 1) +
  theme_minimal() +
  labs(title = "Count of Observations Per Year",
       x = "Year", 
       y = "Count")
```

### Heatmap
We can create a heatmap to display morphometric measurements on a spatial scale. 

```{r heatmap-delete-maybe}
#libraries
#library(d3heatmap)

#creating a dataframe that does not include NA values
seot_meanweights <- seot %>% 
  select(AREA, WEIGHT, FINAL_AGE, BACULA_LGTH, body_lgth, mean_tail_lgth) %>% 
  filter(WEIGHT > 0) %>% 
  filter(FINAL_AGE > 6) %>% 
  filter(BACULA_LGTH > 0) %>% 
  filter(body_lgth > 0 ) %>% 
  filter(mean_tail_lgth > 0)

#creating a dataframe that includes mean morphometric measurements
seot_meanweights <- seot_meanweights %>%
  group_by(AREA) %>% 
  mutate(mean_weight = mean(WEIGHT)) %>% 
  mutate(mean_bacula = mean(BACULA_LGTH)) %>% 
  mutate(mean_bodylgth = mean(body_lgth)) %>% 
  mutate(mean_tail = mean(mean_tail_lgth)) %>% 
  distinct(AREA, mean_tail, mean_bodylgth, mean_bacula, mean_weight)

#
seot_meanweights <- seot_meanweights %>% 
  mutate(mean_tail = as.numeric(mean_tail)) %>% 
  mutate(mean_bacula = as.numeric(mean_bacula)) %>% 
  mutate(mean_bodylgth = as.numeric(mean_bodylgth)) %>% 
  mutate(mean_weight = as.numeric(mean_weight))

#trying to make a heatmap, ask laurie about this...
seot_matrix_weights <- as.matrix(seot_meanweights)
#heatmap(seot_matrix_weights)
```


## Tail Length Analysis

### Tail Length by Sex
We know that sea otter tail lengths are known to be morphometrically different by sex. Let's see if this is true within this dataset. First, let's create a histogram that displays the tail lengths of the male and female otters.

We will want to compare the tail lengths of fully grown adult otters. According to the Alaska Department of Fish and Game, female sea otters become mature around four years of age and male sea otters become mature at age five ([insert citation here]). To account for the age differences within this dataset, we will need to filter the `FINAL_AGE` variable to be greater than or equal to `5`. 

```{r tail-length-sex-histogram}
seot %>% 
  filter(SEX == "M"|SEX == "F") %>% 
  filter(FINAL_AGE > 4) %>% 
  ggplot(mapping = aes(x = mean_tail_lgth, fill = SEX)) + 
  scale_fill_viridis_d(name = "Sex", labels = c("Female", "Male"), option = "cividis") +
  geom_density() + 
  facet_wrap(~SEX, ncol = 1)
```

```{r tail-length-sex-statistics}
#creating data frame with only adult otters
seot_tail <- seot %>% 
  filter(FINAL_AGE > 4)

#Welch's Two Sample t-test
t.test(mean_tail_lgth ~ SEX, data = seot_tail)
```

Report: The tail length of mature male otters (ages 5 and above) is significantly longer than that of mature female otters (Welch Two Sample t-test, t = -2.5123, df = 106.21, p-value = 0.0135). 

** we need to check and see if there are any interactions within this statistic... I still don't trust it. 

### Tail Length by Area

To break down the morphometric differences between the otters, let's begin by looking at the tail lengths of the individuals. 
** should we bootstrap the data so that all of them have an equal representation? we'll see...
```{r tail-length-by-area}
#first, let's factor reorder the areas so their in order of the eastern-most location to the western-most location
seot_taillength <- seot %>% 
  filter(AREA == "andreanof_islands"|AREA == "eastern_alaskan_peninsula"|AREA == "kachemak_bay"|AREA == "northern_southeast_alaska"|AREA == "rat_islands"|AREA == "southern_southeast_alaska"|AREA == "western_alaskan_peninsula"|AREA == "western_prince_william_sound") %>% 
  mutate(AREA = fct_relevel(AREA, c("andreanof_islands", "western_alaskan_peninsula", "southern_southeast_alaska", "northern_southeast_alaska", "eastern_alaskan_peninsula", "kachemak_bay", "western_prince_william_sound")))

#boxplot of tail length by area
seot_taillength %>% 
  ggplot(mapping = aes(x = AREA, y = mean_tail_lgth, color = AREA)) +
  geom_boxplot() + 
  theme(axis.text.x = element_blank()) +
  scale_fill_viridis_d()+
  scale_x_discrete(guide = guide_axis(n.dodge = 4))
```

```{r determining which is eastern vs. western}
seot %>% 
  filter(AREA == "andreanof_islands"|AREA == "eastern_alaskan_peninsula"|AREA == "kachemak_bay"|AREA == "northern_southeast_alaska"|AREA == "rat_islands"|AREA == "southern_southeast_alaska"|AREA == "western_alaskan_peninsula"|AREA == "western_prince_william_sound") %>% 
  ggplot(mapping = aes(x = LAT, y = LONG, color = AREA)) + 
  geom_point()
```


## Age Diversity Among Sexes With Observations

```{r age}
seot %>% 
  filter(SEX != "U") %>% 
  ggplot(aes(x=FINAL_AGE, fill = SEX)) + 
   geom_histogram(binwidth = 1) +
  xlim(0,25) + 
  facet_grid(~SEX)
```

# Statistical Analysis 
## Paw Width and Prey
The paw width data was collected in an effort to study the estimates of prey size in relation to paw size for sea otter foraging studies. If we are able to find the appropriate datasets, it would be interesting to study the relationship between paw size and prey size.

The `PAW` variable is the width of the front paw at the widest point, as measured in millimeters. 

```{r paw-general}
#can I reorder this by region? eastern to western?
seot$REGION <- factor(seot$REGION, levels = c("west_aleutians", "east_aleutians", "alaskan_peninsula", "southeast_alaska", "kodiak", "prince_william_sound"))

seot %>% 
  filter(PAW > 0) %>% 
  ggplot(mapping = aes(x = REGION, y = PAW, color = REGION)) + 
  geom_boxplot() + 
  scale_x_discrete(guide = guide_axis(n.dodge = 3))
```

```{r determining which is eastern vs. western2}
#seot %>% 
  #filter(REGION == "alaskan_peninsula"|REGION == "east_aleutians"|REGION == "kodiak"|REGION == "lower_cook_inlet"|REGION == "prince_william_sound"|REGION == "southeast_alaska"|REGION == "west_aleutians") %>% 
  #ggplot(mapping = aes(x = LAT, y = LONG, color = REGION)) + 
  #geom_point()
```

### Statistical Difference in Paw Size Between Sexes

```{r histogram-paw}
seot %>% 
  filter(PAW > 0) %>% 
  ggplot(mapping = aes(x = PAW, fill = SEX)) +
  geom_histogram() + 
  facet_wrap(~SEX, ncol = 1) + 
  labs(x = "Paw Width (mm)", 
       y = "Count", 
       fill = "Sex")
```

```{r ANOVA-paw-size}
seot_paw <- seot %>% 
  filter(FINAL_AGE > 6)

pawaov <- aov(PAW ~ SEX, data = seot)
summary(pawaov)
```




## Canine and Sexing
The canine width was measured as a potential metric to sex the individuals. We would like to see if there are any significant differences between male canine lengths and female canine lengths (with respect to the ages of the individuals).

The canine measurement is labeled under the `CAN_DIA` column, where a measurement of the diameter of canine tooth (mm) was taken at the gum line, which is the widest dimension. This canine width was measured with a caliper and recorded to the nearest 0.1 mm. 

### Creating Plots
Let's create a plot to visualize the distribution of the data. This will help us determine which type of statistical test will be the most appropriate to use. First, we have to filter the `seot` dataset so that we will be able to visualize the `CAN_DIA` and `SEX` variables that we're interested in. 

```{r glimpsing-canine-measurement-by-sex}
seot_sex <- seot %>% 
  mutate(CAN_DIA = as.numeric(CAN_DIA)) %>% 
  filter(SEX != "U") %>% 
  filter(CAN_DIA > 0) %>% 
  filter(FINAL_AGE > 0)


#boxplot
ggplot(data = seot_sex, mapping = aes(x = SEX, y = CAN_DIA, color = SEX)) + 
  geom_boxplot() + 
  ylim(2,12) + 
  labs(title = "Canine Diameter by Sex",
       x = "Sex",
       y = "Diameter (mm)", 
       color = "Sex")
```

```{r scatterplot-canine}
#scatterplot
ggplot(data = seot_sex, mapping = aes(x = FINAL_AGE, y = CAN_DIA, color = SEX)) + 
  geom_jitter() + 
  ylim(2,12) + 
  geom_smooth(color = "grey") +
  facet_grid(~SEX) +
  labs(title = "Canine Diameter by Sex",
       x = "Sex",
       y = "Diameter (mm)", 
       color = "Sex")

```

```{r interactive-plot-sex}
#interactive scatterplot
ggplotsex <- gapminder %>% 
  ggplot(data = seot_sex, mapping = aes(x = FINAL_AGE, y = CAN_DIA, color = SEX)) + 
  geom_jitter() + 
  ylim(2,12) + 
  scale_color_viridis_d(option = "inferno") +
  geom_smooth(color = "firebrick4") +
  facet_grid(~SEX) +
  labs(title = "Canine Diameter by Sex",
       x = "Sex",
       y = "Diameter (mm)", 
       color = "Sex")

#ggplotly(ggplotsex)

```



```{r canine-histogram}
#histogram
ggplot(data = seot_sex, mapping = aes(x = CAN_DIA, fill = SEX)) +
  geom_histogram() + 
  facet_grid(~SEX) + 
  xlim(2,13) + 
  labs( title = "Canine Diameter of Sea Otters", 
        subtitle = "by Sex", 
        x = "Canine Diameter (mm)", 
        y = "Count", 
        fill = "Sex")
```

To truly determine if the measurement of the canine diameter at the gum line is an appropriate metric by which to sex a sea otter, statistical testing should be performed. As was seen above, the distribution of both sexes appears to conform to a normal distribution. This suggests that we can use a test that follows a two-sample t-test with equal variance. 

```{r stats-canine-ttest}
t.test(CAN_DIA ~ SEX, data = seot_sex, var.equal = TRUE)
```

The diameter of the canine tooth for female sea otters is significantly smaller than that of the male otters (Two Sample t-test; t = -19.164, df = 1132, p-value < 2.2e-16). This would mean that this would be an appropriate metric by which to determine the sex of an unknown sea otter. 

## Baculum Length and Aging

The baculum length was measured on males a way to estimate age-class of the animal. We would like to perform statistical analysis on if there is a difference in baculum length in males of various ages and if this is an appropriate metric by which to estimate the age of male individuals.

The baculum measurement is found under the `BACULA_LGTH` column with the unit of measurement being centimeters. The baculum length was measure using a tape measure and feeling the ends of the bone and recorded to the nearest 0.5 cm.

### Creating Plots
Let's create a plot to visualize the distribution of the data. This will help us determine which type of statistical test will be the most appropriate to use. First, we have to filter the `seot` dataset so that we will be able to visualize the `BACULA_LGTH` and `FINAL_AGE` variables that we're interested in. 

```{r baculum-length-visualization}
seot_baculum <- seot %>% 
  filter(SEX == "M") %>% 
  mutate(FINAL_AGE = as.numeric(FINAL_AGE)) %>% 
  filter(FINAL_AGE > 0) %>% 
  mutate(BACULA_LGTH = as.numeric(BACULA_LGTH)) %>% 
  filter(BACULA_LGTH > 0)

ggplot(data = seot_baculum, mapping = aes(x = FINAL_AGE, y = BACULA_LGTH, color = FINAL_AGE)) +
  geom_jitter() + 
  scale_fill_viridis_c(option = "magma") +
  geom_smooth(color = "firebrick") +
  labs(title = "Baculum Length by Age", 
       x = "Final Age", 
       y = "Bacula Length (cm)", 
       color = "Age")
```

The statistics that we find with the Tukey HSD test that we performed is a little convoluted, so let's tidy this up and group ages into categories and try again. 

```{r tukeyhsd-baculumlength-finalage, message=FALSE}
#create dataframe that includes the variables we want
seot_baculum <- seot_baculum %>% 
  mutate(FINAL_AGE = as.factor(FINAL_AGE)) %>% 
  select(BACULA_LGTH, FINAL_AGE) 

#creating the ANOVA test
aovbaculum <- aov(BACULA_LGTH~FINAL_AGE, data = seot_baculum)
summary(aovbaculum)

#Tukey HSD Test
TukeyHSD(aovbaculum)
```

Now we can more clearly see how the baculum length relates to ages. 

```{r tukeyhsd-baculumlength-agecategory}
#create dataframe that includes the variables we want
seot_baculum_2 <- seot %>% 
  filter(SEX == "M") %>% 
  mutate(AGE_CATEGORY = as.numeric(AGE_CATEGORY)) %>% 
  filter(AGE_CATEGORY > 0) %>% 
  mutate(BACULA_LGTH = as.numeric(BACULA_LGTH)) %>% 
  filter(BACULA_LGTH > 0)

seot_baculum_2 <- seot_baculum_2 %>% 
  mutate(AGE_CATEGORY = as.factor(AGE_CATEGORY)) %>% 
  select(BACULA_LGTH, AGE_CATEGORY) 

#creating the ANOVA test
aovbaculum2 <- aov(BACULA_LGTH~AGE_CATEGORY, data = seot_baculum_2)
summary(aovbaculum2)

#Tukey HSD Test
TukeyHSD(aovbaculum2)
```

REPORT: The baculum length of individuals who are ages 1 - 7 are significantly different than one another (one-way ANOVA, F_2,457, = 112, P < 0.005). In a Tukey HSD post-hoc test, the baculum length of individuals who were from ages 7 to 13 did not differ significantly (refer to Tukey multiple comparisons of means). This would suggest that you could use the baculum length to estimate the age of individuals who were 7 years or younger, but not for individuals who are over 7 years old. 

# Creating a Model of Baculum Length by Age

```{r install-tidymodels}
#install.packages("tidymodels")
#library(tidymodels)
```

For each additional year, the male otter's baculum is expected to grow by 0.22 cm. For otters that are 0 (aka newborn), the baculum length is expected to be 14.33 cm. 
```{r model-baculum-vs-age}
#first, we need to filter out the na values (that being -9.0)
seot_bacula <- seot %>% 
  filter(BACULA_LGTH > 0)

#now, let's create the linear model comparing final age to baculum length
#seot_model_baculum <- linear_reg() %>%
  #set_engine("lm") %>% 
  #fit(BACULA_LGTH ~ FINAL_AGE, data = seot_bacula)

#let's tidy this model
#seot_model_baculum %>% tidy()
```

```{r graphical-diagnostics-baculum}
#augmenting the baculum data
#seot_model_baculum_augment <- augment(seot_model_baculum$fit)

#ggplot(seot_model_baculum_augment, mapping = aes(x = .fitted, y = .resid)) +
  #geom_jitter(alpha = 0.75) +
  #geom_smooth(color = "black") +
  #labs(x = "Predicted Age", y = "Residuals")

#assessing the r-squared value
#glance(seot_model_baculum)$adj.r.squared
```

## Weight by Tail Length

```{r weight-tail-length, warning=FALSE}
#creating a plot that visualizes the relationship between weight and tail length
ggplot(data = seot, mapping = aes(x = WEIGHT, y = mean_tail_lgth, color = WEIGHT)) + 
  geom_point(alpha = 0.75) +
  scale_fill_viridis_c("magma") +
  ylim(15, 40) + 
  xlim(0, 45) + 
  geom_smooth(color = "black") + 
  labs(x = "Weight (kg)", 
       y = "Mean Tail Length (cm)", 
       color = "Weight")
```

With the tail length and the weight of the otter being both quantitative variables, we should use a simple regression statistical test to determine if there is a statistical significance. 

```{r linear-model-tail-weight}
#creating the linear model
weight.tail.lm <- lm(mean_tail_lgth ~ WEIGHT, data = seot)

summary(weight.tail.lm)
```

REPORT: There is a significant relationship (p < 0.001) between tail length and weight of adult otters (R2 = 2.14 ± 0.014), with a 0.23-mm increase in reported tail length for every year increase in the otter's age.

The regression equation is: 
tail length = 24.41 + 0.23(weight) ± 0.014. 


## Recapture Data 

```{r recaptured-otters, include=FALSE}
seot_recapture <- seot %>% 
  select(YEAR, OTTER.NO, FINAL_AGE, WEIGHT, SEX) %>%
  mutate(OTTER.NO = as.factor(OTTER.NO))
```

```{r recapture-data-again, include=FALSE}
seot_recapture %>% 
  filter(OTTER.NO == "SO-01-28") %>% 
  select(YEAR, OTTER.NO, FINAL_AGE, SEX, WEIGHT)

seot_recapture %>% 
  filter(OTTER.NO == "SO-02-07") %>% 
  select(YEAR, OTTER.NO, FINAL_AGE, SEX, WEIGHT)

seot_recapture %>% 
  filter(FINAL_AGE > 0) %>% 
  select(YEAR, OTTER.NO, FINAL_AGE, SEX)
```

# Spatial Analysis
We want to determine if there is a difference of morphometric measurements on a spatial scale.

## Introduction
First, let's see if there is a size difference between Prince William's Sound and the Western Aleutians. 

```{r lat-long-glimpse}
seot %>% 
  filter(REGION == "west_aleutians") %>% 
  count(LOCATION)

seot %>% 
  count(REGION)
```

```{r spatial-difference-pws-wa}
#creating a dataset that includes only the west aleutians and prince williams sound
seot_pws_wa <- seot %>% 
  filter(REGION == "west_aleutians"|REGION == "prince_william_sound") %>% 
  filter(WEIGHT > 0) %>% 
  filter(AGE_CATEGORY > -1) %>% 
  filter(FINAL_AGE > -1)

#mapping weight by age category between the two locations (histogram)
seot_pws_wa %>% 
  filter(AGE_CATEGORY > -1) %>% 
  filter(FINAL_AGE > -1) %>% 
  ggplot(data = seot_pws_wa, mapping = aes(x = WEIGHT), fill = REGION) + 
  geom_histogram() + 
  facet_wrap(AGE_CATEGORY~REGION, ncol = 2) + 
  labs(title = "Weight by Location", 
       x = "Weight (lbs)", 
       y = "Count")
```

```{r jitter-weight-final-age-region}
#mapping weight by age category between the two locations (scatterplot)
#how do I color this differently???
seot_pws_wa %>% 
  filter(FINAL_AGE > -1) %>% 
  ggplot(data = seot_pws_wa, mapping = aes(x = FINAL_AGE, y = WEIGHT, color = FINAL_AGE)) + 
  geom_jitter() +
  scale_fill_brewer(palette = "Set3") +
  facet_wrap(~REGION) +
  geom_smooth(color = "firebrick") +
  labs(x = "Final Age", 
       y = "Weight (lbs)", 
       color = "Final Age")
```

To statistically test this, we would want to perform an ANOVA test. 

### Age Category = 7
Let's compare the weight differences of otters that are in the age category of 5 between the different regions. 

```{r spatial-analysis-ANOVA}
#creating a dataset that includes only the age classes that we want (7)
seot_adult <- seot %>% 
  filter(FINAL_AGE > 4) %>% 
  filter(WEIGHT > 0)

#creating the ANOVA test
aovspatial2 <- aov(WEIGHT~REGION, data = seot_adult)
summary(aovspatial2)

#Tukey HSD Test
TukeyHSD(aovspatial2)
```

REPORT: 
The Western Aleutian otters who were older than 6 years of age were significantly heavier than otters that were captured in the south east region of Alaska (Alaskan Peninsula, Southeast Alaska, Prince William Sound, Lower Cook Inlet, Kodiak Island) (one-way ANOVA, F_6,1472 = 43.37, P < 0.005). 

